const TelegramBot = require('node-telegram-bot-api');
const express = require('express');
const app = express();

// –ü—Ä–æ–≤–µ—Ä—è–µ–º —Ç–æ–∫–µ–Ω
if (!process.env.BOT_TOKEN) {
  console.error('ERROR: BOT_TOKEN not found!');
  process.exit(1);
}

const token = process.env.BOT_TOKEN;
const bot = new TelegramBot(token, {polling: true});

console.log('ü§ñ –ë–æ—Ç –∑–∞–ø—É—Å–∫–∞–µ—Ç—Å—è...');

// –ü—Ä–æ—Å—Ç–æ–µ —Ö—Ä–∞–Ω–∏–ª–∏—â–µ –ø—Ä–æ–≥—Ä–µ—Å—Å–∞
const userProgress = {};

// –ú–µ–Ω—é
const mainMenu = {
  reply_markup: {
    keyboard: [
      ['üéì –£—Ä–æ–∫–∏', 'üìö –ü—Ä–∏–º–µ—Ä—ã'],
      ['‚≠ê –ü—Ä–æ–≥—Ä–µ—Å—Å', '‚ùì –ü–æ–º–æ—â—å']
    ],
    resize_keyboard: true
  }
};

// –û–±—Ä–∞–±–æ—Ç—á–∏–∫ –∫–æ–º–∞–Ω–¥—ã /start
bot.onText(/\/start/, (msg) => {
  const chatId = msg.chat.id;
  const userName = msg.from.first_name || '–¥—Ä—É–≥';
  
  console.log(`üëã –ù–æ–≤—ã–π –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å: ${userName}`);
  
  const welcomeText = `–ü—Ä–∏–≤–µ—Ç, ${userName}! –Ø –ê–Ω–∏–º–∞–¥—Ä—É–≥! üé®\n\n–Ø –ø–æ–º–æ–≥—É —Ç–µ–±–µ –æ—Å–≤–æ–∏—Ç—å –∞–Ω–∏–º–∞—Ü–∏—é!`;
  bot.sendMessage(chatId, welcomeText, mainMenu);
});

// –û–±—Ä–∞–±–æ—Ç—á–∏–∫ –≤—Å–µ—Ö —Å–æ–æ–±—â–µ–Ω–∏–π
bot.on('message', (msg) => {
  const chatId = msg.chat.id;
  const text = msg.text;
  const userName = msg.from.first_name || '–¥—Ä—É–≥';

  console.log(`üì® –°–æ–æ–±—â–µ–Ω–∏–µ –æ—Ç ${userName}: ${text}`);

  // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä—É–µ–º –ø—Ä–æ–≥—Ä–µ—Å—Å –µ—Å–ª–∏ –Ω—É–∂–Ω–æ
  if (!userProgress[chatId]) {
    userProgress[chatId] = { lessonsCompleted: [] };
  }

  // –û–±—Ä–∞–±–æ—Ç–∫–∞ –∫–Ω–æ–ø–æ–∫
  if (text === 'üéì –£—Ä–æ–∫–∏') {
    const lessonsText = `–í—ã–±–µ—Ä–∏ —É—Ä–æ–∫ –∞–Ω–∏–º–∞—Ü–∏–∏:\n\n` +
                       `1. üìù –ü—Ä—ã–≥–∞—é—â–∏–π —à–∞—Ä–∏–∫\n` +
                       `2. üé® –ë–µ–≥—É—â–∏–π —á–µ–ª–æ–≤–µ—á–µ–∫\n` +
                       `3. ‚ú® –õ–µ—Ç–∞—é—â–∞—è –ø—Ç–∏—Ü–∞\n\n` +
                       `–ù–∞–ø–∏—à–∏ –Ω–æ–º–µ—Ä —É—Ä–æ–∫–∞ (1, 2 –∏–ª–∏ 3)`;
    bot.sendMessage(chatId, lessonsText, mainMenu);
  }
  else if (text === '1' || text === 'üìù –ü—Ä—ã–≥–∞—é—â–∏–π —à–∞—Ä–∏–∫') {
    const lessonText = `üéæ **–£—Ä–æ–∫ 1: –ü—Ä—ã–≥–∞—é—â–∏–π —à–∞—Ä–∏–∫**\n\n` +
                       `**–ó–∞–¥–∞–Ω–∏–µ:** –ù–∞—Ä–∏—Å—É–π 3 –∫–∞–¥—Ä–∞:\n` +
                       `1. –®–∞—Ä–∏–∫ –≤–≤–µ—Ä—Ö—É (—Å–∂–∞—Ç—ã–π)\n` +
                       `2. –®–∞—Ä–∏–∫ –≤–Ω–∏–∑—É (—Ä–∞—Å—Ç—è–Ω—É—Ç—ã–π)\n` +
                       `3. –®–∞—Ä–∏–∫ —Å–Ω–æ–≤–∞ –≤–≤–µ—Ä—Ö—É\n\n` +
                       `**–ü—Ä–∏–º–µ—Ä:**\n` +
                       `–ö–∞–¥—Ä 1: ‚óã (–≤–≤–µ—Ä—Ö—É)\n` +
                       `–ö–∞–¥—Ä 2: O (–≤–Ω–∏–∑—É, —Ä–∞—Å—Ç—è–Ω—É—Ç—ã–π)\n` +
                       `–ö–∞–¥—Ä 3: ‚óã (—Å–Ω–æ–≤–∞ –≤–≤–µ—Ä—Ö—É)\n\n` +
                       `–ü—Ä–∏—Å—ã–ª–∞–π —Å–≤–æ–∏ —Ä–∏—Å—É–Ω–∫–∏! üé®`;
    bot.sendMessage(chatId, lessonText, mainMenu);
  }
  else if (text === '2' || text === 'üé® –ë–µ–≥—É—â–∏–π —á–µ–ª–æ–≤–µ—á–µ–∫') {
    const lessonText = `üèÉ‚Äç‚ôÇÔ∏è **–£—Ä–æ–∫ 2: –ë–µ–≥—É—â–∏–π —á–µ–ª–æ–≤–µ—á–µ–∫**\n\n` +
                       `**–ó–∞–¥–∞–Ω–∏–µ:** –ù–∞—Ä–∏—Å—É–π 4 –∫–∞–¥—Ä–∞ –±–µ–≥–∞:\n` +
                       `1. –ü–æ–¥–≥–æ—Ç–æ–≤–∫–∞ –∫ —à–∞–≥—É\n` +
                       `2. –ü–µ—Ä–µ–Ω–æ—Å –≤–µ—Å–∞\n` +
                       `3. –¢–æ–ª—á–æ–∫\n` +
                       `4. –ü–æ–ª—ë—Ç–Ω–∞—è —Ñ–∞–∑–∞\n\n` +
                       `–ù–∞—á–Ω–∏ —Å –ø—Ä–æ—Å—Ç–æ–≥–æ —á–µ–ª–æ–≤–µ—á–∫–∞ –∏–∑ –ø–∞–ª–æ—á–µ–∫!`;
    bot.sendMessage(chatId, lessonText, mainMenu);
  }
  else if (text === '3' || text === '‚ú® –õ–µ—Ç–∞—é—â–∞—è –ø—Ç–∏—Ü–∞') {
    const lessonText = `üïäÔ∏è **–£—Ä–æ–∫ 3: –õ–µ—Ç–∞—é—â–∞—è –ø—Ç–∏—Ü–∞**\n\n` +
                       `**–ó–∞–¥–∞–Ω–∏–µ:** –ù–∞—Ä–∏—Å—É–π 3 –∫–∞–¥—Ä–∞:\n` +
                       `1. –ö—Ä—ã–ª—å—è –≤–≤–µ—Ä—Ö—É\n` +
                       `2. –ö—Ä—ã–ª—å—è –ø–æ—Å–µ—Ä–µ–¥–∏–Ω–µ\n` +
                       `3. –ö—Ä—ã–ª—å—è –≤–Ω–∏–∑—É\n\n` +
                       `–°–¥–µ–ª–∞–π –¥–≤–∏–∂–µ–Ω–∏–µ –ø–ª–∞–≤–Ω—ã–º!`;
    bot.sendMessage(chatId, lessonText, mainMenu);
  }
  else if (text === 'üìö –ü—Ä–∏–º–µ—Ä—ã') {
    const examplesText = `üìö **–ü—Ä–∏–º–µ—Ä—ã –∞–Ω–∏–º–∞—Ü–∏–π:**\n\n` +
                         `üéæ **–ü—Ä—ã–≥–∞—é—â–∏–π —à–∞—Ä–∏–∫:**\n` +
                         `–®–∞—Ä–∏–∫ –º–µ–Ω—è–µ—Ç —Ñ–æ—Ä–º—É –ø—Ä–∏ –¥–≤–∏–∂–µ–Ω–∏–∏!\n\n` +
                         `üèÉ‚Äç‚ôÇÔ∏è **–ë–µ–≥—É—â–∏–π —á–µ–ª–æ–≤–µ—á–µ–∫:**\n` +
                         `–¶–∏–∫–ª –∏–∑ 4 —Ñ–∞–∑ –±–µ–≥–∞\n\n` +
                         `üïäÔ∏è **–õ–µ—Ç–∞—é—â–∞—è –ø—Ç–∏—Ü–∞:**\n` +
                         `–ü–ª–∞–≤–Ω–æ–µ –¥–≤–∏–∂–µ–Ω–∏–µ –∫—Ä—ã–ª—å–µ–≤\n\n` +
                         `–í—ã–±–∏—Ä–∞–π —É—Ä–æ–∫ –∏ –Ω–∞—á–∏–Ω–∞–π —Ç–≤–æ—Ä–∏—Ç—å! ‚ú®`;
    bot.sendMessage(chatId, examplesText, mainMenu);
  }
  else if (text === '‚≠ê –ü—Ä–æ–≥—Ä–µ—Å—Å') {
    const progress = userProgress[chatId];
    const completed = progress.lessonsCompleted.length;
    
    let progressText = `‚≠ê **–¢–≤–æ–π –ø—Ä–æ–≥—Ä–µ—Å—Å, ${userName}:**\n\n` +
                       `‚úÖ –ü—Ä–æ–π–¥–µ–Ω–æ —É—Ä–æ–∫–æ–≤: ${completed}/3\n\n`;
    
    if (completed === 0) {
      progressText += `–ù–∞—á–Ω–∏ —Å–≤–æ–π –ø–µ—Ä–≤—ã–π —É—Ä–æ–∫! üöÄ`;
    } else if (completed === 3) {
      progressText += `–¢—ã –∑–∞–≤–µ—Ä—à–∏–ª(–∞) –≤—Å–µ —É—Ä–æ–∫–∏! üèÜ`;
    } else {
      progressText += `–ü—Ä–æ–¥–æ–ª–∂–∞–π –≤ —Ç–æ–º –∂–µ –¥—É—Ö–µ! üí™`;
    }
    
    bot.sendMessage(chatId, progressText, mainMenu);
  }
  else if (text === '‚ùì –ü–æ–º–æ—â—å') {
    const helpText = `‚ùì **–ü–æ–º–æ—â—å:**\n\n` +
                     `–Ø –ø–æ–º–æ–≥—É —Ç–µ–±–µ –Ω–∞—É—á–∏—Ç—å—Å—è –∞–Ω–∏–º–∞—Ü–∏–∏!\n\n` +
                     `‚Ä¢ üéì –£—Ä–æ–∫–∏ - –≤—ã–±–µ—Ä–∏ –∏ –ø—Ä–æ–π–¥–∏ —É—Ä–æ–∫\n` +
                     `‚Ä¢ üìö –ü—Ä–∏–º–µ—Ä—ã - –ø–æ—Å–º–æ—Ç—Ä–∏ –ø—Ä–∏–º–µ—Ä—ã\n` +
                     `‚Ä¢ ‚≠ê –ü—Ä–æ–≥—Ä–µ—Å—Å - —É–∑–Ω–∞–π —Å–≤–æ–∏ —É—Å–ø–µ—Ö–∏\n\n` +
                     `–ü—Ä–æ—Å—Ç–æ –Ω–∞–∂–∏–º–∞–π –∫–Ω–æ–ø–∫–∏ –≤ –º–µ–Ω—é!`;
    bot.sendMessage(chatId, helpText, mainMenu);
  }
  else if (text === '/help' || text === '/start') {
    // –≠—Ç–∏ –∫–æ–º–∞–Ω–¥—ã —É–∂–µ –æ–±—Ä–∞–±–∞—Ç—ã–≤–∞—é—Ç—Å—è –æ—Ç–¥–µ–ª—å–Ω–æ
  }
  else {
    // –ï—Å–ª–∏ —Å–æ–æ–±—â–µ–Ω–∏–µ –Ω–µ —Ä–∞—Å–ø–æ–∑–Ω–∞–Ω–æ
    bot.sendMessage(chatId, 
      `–ò—Å–ø–æ–ª—å–∑—É–π –∫–Ω–æ–ø–∫–∏ –º–µ–Ω—é –Ω–∏–∂–µ üëá\n–ò–ª–∏ –Ω–∞–ø–∏—à–∏ /start –¥–ª—è –ø–µ—Ä–µ–∑–∞–ø—É—Å–∫–∞`, 
      mainMenu
    );
  }
});

// –û–±—Ä–∞–±–æ—Ç–∫–∞ —Ñ–æ—Ç–æ
bot.on('photo', (msg) => {
  const chatId = msg.chat.id;
  const userName = msg.from.first_name || '–¥—Ä—É–≥';
  
  console.log(`üì∏ ${userName} –æ—Ç–ø—Ä–∞–≤–∏–ª(–∞) —Ñ–æ—Ç–æ`);
  
  const response = `–ö—Ä—É—Ç–æ, ${userName}! –¢—ã –æ—Ç–ø—Ä–∞–≤–∏–ª(–∞) —Ä–∏—Å—É–Ω–æ–∫! üé®\n\n` +
                   `–ü—Ä–æ–¥–æ–ª–∂–∞–π –ø—Ä–∞–∫—Ç–∏–∫–æ–≤–∞—Ç—å—Å—è - —É —Ç–µ–±—è –æ—Ç–ª–∏—á–Ω–æ –ø–æ–ª—É—á–∞–µ—Ç—Å—è! ‚ú®`;
  
  bot.sendMessage(chatId, response, mainMenu);
});

// –ó–∞–ø—É—Å–∫ —Å–µ—Ä–≤–µ—Ä–∞
const PORT = process.env.PORT || 3000;
app.listen(PORT, () => {
  console.log(`‚úÖ –ë–æ—Ç –∑–∞–ø—É—â–µ–Ω –Ω–∞ –ø–æ—Ä—Ç—É ${PORT}`);
});

// –û–±—Ä–∞–±–æ—Ç–∫–∞ –æ—à–∏–±–æ–∫
bot.on('error', (error) => {
  console.error('‚ùå –û—à–∏–±–∫–∞ –±–æ—Ç–∞:', error);
});

process.on('uncaughtException', (error) => {
  console.error('‚ö†Ô∏è –ù–µ–æ–±—Ä–∞–±–æ—Ç–∞–Ω–Ω–∞—è –æ—à–∏–±–∫–∞:', error);
});
